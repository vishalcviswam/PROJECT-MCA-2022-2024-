<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Recorder</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f7;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            background: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 20px;
            width: 600px;
        }

        .button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .content-box {
            border: 1px solid #e1e4e8;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            min-height: 50px;
        }

        #transcriptionContainer, #randomContentContainer {
            background-color: #f8f9fa;
            color: #212529;
        }

        h2 {
            color: #333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Audio Recorder</h2>

    <div id="randomContentContainer" class="content-box">{{ random_content }}</div>
    <button onclick="generateRandomContent()" class="button">Generate Random Content</button>
    <button onclick="speakCurrentText()" class="button">Pronounce Text</button>

    <div id="transcriptionContainer" class="content-box">Transcription will appear here...</div>
    <div id="missingWords">Missing Words: </div>
    <div id="extraWords">Extra Words: </div>

    <button id="startButton" onclick="startRecording()" class="button">Start Recording</button>
    <button id="stopButton" onclick="stopRecording()" disabled class="button">Stop Recording</button>
    <button id="transcribeButton" onclick="transcribeAudio()" disabled class="button">Transcribe</button>
</div>

<script>
     // Function to get the CSRF token from the cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let mediaRecorder;
        let audioChunks = [];

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        document.getElementById('transcribeButton').disabled = false;
                    };
                    mediaRecorder.start();
                    document.getElementById('startButton').disabled = true;
                    document.getElementById('stopButton').disabled = false;
                });
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Stop each track on the stream
                mediaRecorder.onstop = () => {
                    document.getElementById('transcribeButton').disabled = false;
                };
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
            }
        }
        
        function transcribeAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            sendDataToServer(audioBlob);
            audioChunks = []; // Clear the chunks array for the next recording
        }

        function sendDataToServer(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob);
            const csrftoken = getCookie('csrftoken'); // Get the CSRF token
        
            fetch("/upload/", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": csrftoken // Include the CSRF token in the header
                },
                credentials: 'include' // Include cookies in the request (needed for CSRF)
            })
            .then(response => response.text())
            .then(data => {
                // Assuming the server response is in the format "Transcribed Text: actual transcribed text"
                // We need to extract the actual transcribed text after the label
                const transcribedText = data.replace("Transcribed Text: ", "").trim();
        
                // Display the transcription in the container
                document.getElementById('transcriptionContainer').innerText = transcribedText; 
        
                // Get the expected text from the randomContentContainer
                const expectedText = document.getElementById('randomContentContainer').innerText;
        
                // Call compareTexts with the expected text and the transcribed text
                compareTexts(expectedText, transcribedText);
            });
        }
        
        

        function generateRandomContent() {
            fetch('/get-random-content/') // URL to the Django view that returns random content
                .then(response => response.text())
                .then(text => {
                    document.getElementById('randomContentContainer').innerText = text;
                    speakText(text);
                })
                .catch(error => {
                    console.error('Error fetching random content:', error);
                    document.getElementById('randomContentContainer').innerText = 'Failed to load new content.';
                });
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                // Optionally set voice, pitch, and rate properties here
                speechSynthesis.speak(utterance);
            } else {
                console.error("Speech synthesis not supported in this browser.");
            }
        }

        function speakCurrentText() {
            const text = document.getElementById('randomContentContainer').innerText;
            speakText(text);
        }

        function compareTexts(expectedText, transcribedText) {
            const normalizeText = (text) => text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(' ').filter(Boolean);
            
            const expectedWords = normalizeText(expectedText);
            const transcribedWords = normalizeText(transcribedText);
            
            const missingWords = expectedWords.filter(word => !transcribedWords.includes(word));
            const extraWords = transcribedWords.filter(word => !expectedWords.includes(word));
        
            // Update the page with the results
            document.getElementById('missingWords').innerText = "Missing Words: " + missingWords.join(', ');
            document.getElementById('extraWords').innerText = "Extra Words: " + extraWords.join(', ');
        }
        
</script>

</body>
</html>
